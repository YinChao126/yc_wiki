# 算法和软件优化技术综述

作者：尹超

日期：2019-7-2

## 1. 背景介绍

​	本人并非科班出身的优化工程师，只是在工作中接到了关于优化方面的任务，没办法只能迎难而上，在工作中渐渐积累了关于优化的各种技巧。

​	我手里有一个C++的通信算法，需要将该算法移植到各种嵌入式平台中（DSP, ARM)，由于通信算法有严格的实时性要求（速率恒定为650K），ARM平台的硬件资源只有150MHz，256+128K内存。所以必须对算法进行时间和空间两方面的大幅优化（未优化前评估需提速10倍，内存压缩20倍以上）

​	过程是曲折的，期间也无人指点迷津，只能靠自己瞎子摸象去探索，简直是无所不用其极，各种手段用尽了。好在结果是好的，最终经过一年的努力，分别在DSP平台和ARM平台圆满完成了优化任务（以DSP为例，单过程指令周期数从150亿降低到7.8亿，内存占用从数M降低到256+64K），最终保证了我司首款自研芯片（SK9042）成功量产。回顾这一过程，自觉收获颇多，零零散散的经验拼起来居然也能解决大问题。

​	下文是个人对上述工作的一次经验总结，有不足之处还请多多指教。联系方式参见about。

## 2. 所需基本功

- 熟悉操作系统原理

- 熟悉处理器内部结构

- 掌握常用profile工具

- 熟悉汇编

- 掌握常用优化技巧

- 熟悉矢量化编程（NEON，SIMD）


## 3. 优化的重要思想

千条万条第一条， **牢记二八法则**，切忌眉毛胡子一把抓

**明确目标**，优化总是无止境的，项目进度却不等人

**明确可用资源**，物尽其用，

**时空互换**，随着优化的深入，甚至会发现自己在这两者间玩平衡

## 4. 优化具体步骤

先体检，再确定症结，再对症下药，最后不断迭代以达到优化指标要求

### 4.1 体检，确定症结

​	磨刀不误砍柴工，找一个合适的profile工具，对源码进行一次热点大检查

​	庖丁解牛，通过分析源码，明确整个工程分为几大块，通过cycle计数来测算各个模块的整体资源占比，通过屏蔽和使能特定模块来进一步确定症结所在

​	最终把资源消耗最高的几个部分拎出来，集中精力去给它降温

### 4.2 对症下药

按照“**架构优化 > 算法重构 > 源码优化 > 汇编优化**”的思路进行具体优化

- 所谓架构优化，是指针对一个完整过程(任务)模块进行流程上的优化，比如多线程的安排，中断安排，避免重复过程，提高整体资源利用率。<u>后面做的再精妙，也许回头来看整个过程都是多余的</u>。 **整体提速明显**（看似不起眼的自加和重复拷贝，如果调用频繁，优化以后整体会提速许多）
- 所谓算法重构，是指针对一个具体算法或函数采用更巧妙的实现（1+2+...+100 = 50 * 101)，有条件甚至可以叫算法工程师去重写。局部可提速数倍甚至数十倍
- 所谓源码优化，是指利用常用编程技巧（循环嵌套，展开，乘法改移位等），换用内置函数等手段进行优化。这个是最常见的优化等级。局部可提速数倍
- 所谓汇编优化，是指针对特定平台的指令集，直接进行内嵌汇编改写。不到万不得已不要做，一方面提升很有限（得益于高效的编译器，自动编译出来的代码效率也比较高了），另一方面没有可读性，不便于维护。局部优化幅度估计在20%以内
- 根据个人经验，效果逐级递减，动静也逐级递减（越到后面越纯粹，需要协同的越少）

### 4.3 不断迭代，在优化的过程中动态调整当前策略

​	始终保证枪头对准那消耗80%资源的20%的代码，权衡此刻到底是时间换空间还是空间换时间

### 4.4 用指令集进行内嵌汇编

​	黔驴技穷还搞不定，那只能上核武器了。把目标平台的指令集拿出来（以cortex-m3为例），对准短小精悍，过程独立，调用频繁，开销巨大的核心算法进行内嵌汇编改写。

## 5. 常用优化技巧一览表

- 永远牢记28法则
- 记得打开编译器优化选项
- 看看反汇编的代码
- 循环时自减而不是自加

- 循环展开

- 确保32位指令是处理32位数据的

- 将代码搬到SRAM里去运行（如果是STM处理器，不建议如此）
- 避免浮点/除法运算
- 乘法改移位
- 开根号/求对数，使用快速简化运算
- 循环展开
- 循环内部小循环套大循环
- 循环体内避免出现判断语句，避免出现链表
- 减少函数调用，对于纯粹的，调用频繁的函数进行内联
- 函数定义不能超过4个参数，如做不到请用结构体将参数打包，传入结构体指针
- 把循环体里的判断干掉
- else可以想办法去掉
- 定义二维数组时，外层一定要是2的倍数。  int arr[3][23]改为int arr[3][32];
- 优化循环：for改为do...while, 并且要递减（效率最高的一种循环模式）
- 尽量避免赋值时的隐式类型转换（保证数据类型一致）
- 局部的函数定义为static

## 6. 后记

​	无招胜有招，当优化水平提高到一定境界，可能都不需要上面眼花缭乱的技法来支撑自己的“优化工程师”头衔。曾在网上看到一个写了35年的老程序员说他的优化经验就只有两条，先用profile工具找到热点在哪里，然后直接进去看汇编代码即可发现瓶颈所在。本人的恩师胡老师也曾经亲临指导过，我眼看着他直接对着一片内存（我肯定是完全懵逼）看了一番，然后找出了症结所在。。。

​	让我不禁想起了杨过断臂修炼时拿起的那把巨剑，真是重剑无锋，大巧不工。

## 精选参考链接

[很有参考价值的 programming optimization](http://www.azillionmonkeys.com/qed/optimize.html)

[性能调优攻略](http://coolshell.cn/articles/7490.html)

[C\C++代码优化的27个建议](http://blog.jobbole.com/67880/)

[C语言编程优化运行速度](http://blog.csdn.net/sunjiajiang/article/details/7887724)

[Profiler工具](http://www.cnblogs.com/likwo/archive/2012/12/20/2826988.html)

[代码优化注意事项](http://www.iteye.com/news/26814)

