# 提高Cache命中率

作者：尹超

日期：2019-7-2

## keywords

opt,  cache

## 前沿

​	CPU的处理速度大大高于内存的存取速度，但是代码运行时cpu访问内存却是家常便饭，如果直接交互那么CPU显然会经常等待内存的响应，CPU性能再高也没意义。高速cache就架起了一座连接cpu和内存的桥梁。当处理器在飞速计算时，cache可以主动预测后续的过程，一次性加载许多内容。

​	CPU基本上都有几级流水线，流水线的机制可以保证代码执行时取指令、计算、读写看起来能同时进行。显而易见，让流水线能够顺利流起来可以大幅提高整体效率。

​	如果执行的是一个确定性过程，那这根本不是问题，但如果是一堆判断逻辑，上述的预测就不一定对了。cache一旦猜错，cache内部的资源要重新被清空，流水线全部废掉（hazard），不仅不起作用，还帮了倒忙。

​	由此可见，提高cache的命中率对提升CPU效率，对整体性能优化意义重大。事实上，在profile过程中，cache命中率就是一个衡量CPU运行效率的重要指标。

## 提高Cache命中率的核心思想

​	根据上述内容所述，显而易见，代码越是可预测，命中率越高。因此归根结底问题化简为：**提高代码的可预测性**。

## 常用经验

1. 循环体要纯粹，尽量避免循环
2. 循环嵌套时，次数多的安排在内层
3. 循环种避免使用链表
4. 循环体展开

## 参考链接

[流水线](http://blog.sina.com.cn/s/blog_488c30d301013kuf.html)

